<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Detective-X</title>
  <!-- External Libraries -->
  <script src="https://cdn.tailwindcss.com/3.3.5"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- CSS Styles -->
  <style>
    /* Animation Keyframes */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    @keyframes popup {
      0% { opacity: 0; transform: translate(-50%, -60%); }
      100% { opacity: 1; transform: translate(-50%, -50%); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    
    /* Animation Classes */
    .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
    .animate-popup { animation: popup 0.5s ease-in-out; }
    .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
    
    /* General Styles */
    .hidden { display: none; }
    .thai-date { font-family: 'Kanit', sans-serif; }
    
    /* PDF Export Styles */
    .pdf-hide { display: block; }
    .pdf-image { width: 12rem; height: 12rem; }
    
    /* Loading Spinner */
    .loading-spinner {
      width: 64px;
      height: 64px;
      position: relative;
    }
    .loading-spinner:before, .loading-spinner:after {
      content: '';
      border-radius: 50%;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .loading-spinner:before {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      animation: spin 1s linear infinite;
      background: conic-gradient(transparent, rgba(59, 130, 246, 0.5), rgba(59, 130, 246, 1));
    }
    .loading-spinner:after {
      box-shadow: inset 0 0 0 3px rgba(59, 130, 246, 0.1), 
                  inset 0 0 0 6px rgba(59, 130, 246, 0.2),
                  inset 0 0 0 9px rgba(59, 130, 246, 0.3),
                  inset 0 0 0 12px rgba(59, 130, 246, 0.4);
    }
    
    /* 3D Button Effect */
    .btn-3d {
      position: relative;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: all 0.2s ease;
      top: 0;
    }
    .btn-3d:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      top: -2px;
    }
    .btn-3d:active {
      box-shadow: 0 5px 10px -3px rgba(0, 0, 0, 0.1), 0 2px 3px -2px rgba(0, 0, 0, 0.05);
      top: 0;
    }
    
    /* Responsive Styles */
    @media (max-width: 640px) {
      .table-responsive {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }
      
      .table-responsive th,
      .table-responsive td {
        min-width: 100px;
      }
      
      .modal-mobile {
        padding: 1rem;
        max-height: 90vh;
        overflow-y: auto;
      }
      
      .mobile-text-base { font-size: 0.9rem !important; }
      .mobile-text-lg { font-size: 1.1rem !important; }
      .mobile-text-xl { font-size: 1.25rem !important; }
      
      .mobile-btn {
        padding: 0.5rem !important;
        font-size: 0.85rem !important;
      }
      
      .mobile-form-spacing > div {
        margin-bottom: 1rem !important;
      }
      
      .pdf-btn-mobile {
        width: 100% !important;
        margin-top: 0.5rem !important;
      }
    }
  </style>
</head>
<body class="bg-blue-50 font-['Kanit'] flex items-center justify-center min-h-screen">
  <!-- Loading Spinner -->
  <div id="loading" class="hidden fixed inset-0 flex items-center justify-center z-50">
    <div class="bg-white bg-opacity-90 p-8 rounded-lg shadow-2xl border border-blue-200 animate-fade-in">
      <div class="flex flex-col items-center justify-center">
        <div class="loading-spinner mb-4"></div>
        <div class="mt-4 text-blue-600 text-lg font-medium animate-pulse-slow">
          <i class="fas fa-database mr-2"></i> р╕Бр╕│р╕ер╕▒р╕Зр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕г...
        </div>
      </div>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="password-container" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md text-center animate-fade-in">
    <h1 class="text-4xl font-bold text-blue-500 mb-6">Detective-X System</h1>
    <div class="mb-2 text-gray-600 text-sm">р╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щ: khunthalay (р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╕гр╕░р╕Ър╕Ъ)</div>
    <label for="password" class="block text-gray-700 text-lg mb-2">ЁЯФСр╕Бр╕гр╕нр╕Бр╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щ</label>
    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-blue-500" required />
    <button onclick="checkPassword()" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition duration-300 btn-3d">р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ъ</button>
    <div id="password-status" class="text-red-500 mt-4"></div>
  </div>

  <!-- Main Menu -->
  <div id="main-menu" class="bg-white rounded-lg shadow-lg p-6 sm:p-8 w-full max-w-md text-center hidden animate-fade-in">
    <h1 class="text-3xl sm:text-4xl font-bold text-blue-500 mb-6">Detective-X</h1>
    <div class="grid grid-cols-1 gap-4">
      <button onclick="showForm()" class="bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition duration-300 flex items-center justify-center btn-3d">
        <i class="fas fa-plus-circle mr-2"></i> р╣Ар╕Юр╕┤р╣Ир╕бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕лр╕бр╣И
      </button>
      <button onclick="showDatabase()" class="bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition duration-300 flex items-center justify-center btn-3d">
        <i class="fas fa-database mr-2"></i> р╕Фр╕╣р╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
      </button>
      <button onclick="logout()" class="bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition duration-300 flex items-center justify-center btn-3d">
        <i class="fas fa-sign-out-alt mr-2"></i> р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ
      </button>
    </div>
  </div>

  <!-- Data Entry Form -->
  <div id="form-container" class="bg-white rounded-lg shadow-lg p-4 sm:p-8 w-full max-w-4xl hidden animate-fade-in">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-500 mb-4 sm:mb-0">ЁЯУТр╕гр╕░р╕Ър╕Ър╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕кр╕╖р╕Ър╕кр╕зр╕Щ</h1>
      <button onclick="backToMainMenu()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-300 btn-3d">
        <i class="fas fa-arrow-left mr-2"></i> р╕Бр╕ер╕▒р╕Ър╕лр╕Щр╣Йр╕▓р╕лр╕ер╕▒р╕Б
      </button>
    </div>
    
    <form id="field-form" class="space-y-4 sm:space-y-6 mobile-form-spacing">
      <input type="hidden" id="record-id" value="" />
      <input type="hidden" id="existing-image-url" value="" />
      
      <!-- Date and Time -->
      <div>
        <label for="datetime" class="block text-gray-700 text-base sm:text-lg mb-2">ЁЯУЕр╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Бр╕ер╕░р╣Ар╕зр╕ер╕▓:</label>
        <input type="datetime-local" id="datetime" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" required />
      </div>

      <!-- ID Card Number -->
      <div>
        <label for="id-card" class="block text-gray-700 text-base sm:text-lg mb-2">ЁЯЖФр╣Ар╕ер╕Вр╕Ър╕▒р╕Хр╕гр╕Ыр╕гр╕░р╕Кр╕▓р╕Кр╕Щ:</label>
        <input type="text" id="id-card" maxlength="13" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" required oninput="validateIDCard()" />
        <div id="id-card-status" class="text-red-500 mt-2 hidden"></div>
      </div>

      <!-- Name Prefix -->
      <div>
        <label for="prefix" class="block text-gray-700 text-base sm:text-lg mb-2">ЁЯСдр╕Др╕│р╕Щр╕│р╕лр╕Щр╣Йр╕▓:</label>
        <select id="prefix" class="w-auto sm:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" required>
          <option value="р╕Щр╕▓р╕в">р╕Щр╕▓р╕в</option>
          <option value="р╕Щр╕▓р╕Зр╕кр╕▓р╕з">р╕Щр╕▓р╕Зр╕кр╕▓р╕з</option>
          <option value="р╕Щр╕▓р╕З">р╕Щр╕▓р╕З</option>
        </select>
      </div>

      <!-- Full Name -->
      <div>
        <label for="fullname" class="block text-gray-700 text-base sm:text-lg mb-2">ЁЯСдр╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е:</label>
        <input type="text" id="fullname" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" required />
      </div>

      <!-- Birth Date -->
      <div>
        <label for="birthdate" class="block text-gray-700 text-base sm:text-lg mb-2">ЁЯУЕр╕зр╕▒р╕Щ/р╣Ар╕Фр╕╖р╕нр╕Щ/р╕Ыр╕╡р╣Ар╕Бр╕┤р╕Ф:</label>
        <input type="date" id="birthdate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" required onchange="calculateAge()" />
        <div id="age-display" class="text-blue-500 mt-2"></div>
      </div>

      <!-- ID Card Address -->
      <div>
        <label for="address-id" class="block text-gray-700 text-base sm:text-lg mb-2">ЁЯПар╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣Ир╕Хр╕▓р╕бр╕Ър╕▒р╕Хр╕гр╕Ыр╕гр╕░р╕Кр╕▓р╕Кр╕Щ:</label>
        <textarea id="address-id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" required></textarea>
      </div>

      <!-- Current Address -->
      <div>
        <label for="address-current" class="block text-gray-700 text-base sm:text-lg mb-2">ЁЯПбр╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣Ир╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ:</label>
        <textarea id="address-current" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" required></textarea>
      </div>

      <!-- Phone Number -->
      <div>
        <label for="phone" class="block text-gray-700 text-base sm:text-lg mb-2">ЁЯУЮр╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕г(р╕Бр╕гр╕Ур╕╡р╕бр╕▓р╕Бр╕Бр╕зр╣Ир╕▓1р╣Ар╕Ър╕нр╕гр╣Мр╣Гр╕лр╣Йр╣Гр╕Кр╣Й/р╕Др╕▒р╣Ир╕Щ):</label>
        <input type="text" id="phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" required oninput="validatePhone()" />
        <div id="phone-status" class="text-red-500 mt-2"></div>
      </div>

      <!-- Location -->
      <div>
        <label for="location" class="block text-gray-700 text-base sm:text-lg mb-2">ЁЯПар╕кр╕Цр╕▓р╕Щр╕Чр╕╡р╣И:</label>
        <input type="text" id="location" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" required />
      </div>

      <!-- Coordinates -->
      <div>
        <label for="latlong" class="block text-gray-700 text-base sm:text-lg mb-2">ЁЯУМр╕Юр╕┤р╕Бр╕▒р╕Ф:</label>
        <div class="flex flex-col sm:flex-row gap-2">
          <input type="text" id="latlong" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" required />
          <button type="button" onclick="getLatLong()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300 btn-3d">
            <i class="fas fa-map-marker-alt mr-2"></i> р╕гр╕▒р╕Ър╕Др╣Ир╕▓р╕Юр╕┤р╕Бр╕▒р╕Ф
          </button>
        </div>
      </div>

      <!-- Details -->
      <div>
        <label for="details" class="block text-gray-700 text-base sm:text-lg mb-2">тЬПя╕Пр╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф:</label>
        <textarea id="details" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 h-32" required></textarea>
      </div>

      <!-- Image Upload -->
      <div>
        <label for="image-upload" class="block text-gray-700 text-base sm:text-lg mb-2">ЁЯУ╖р╕нр╕▒р╕Юр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Ю:</label>
        <input type="file" id="image-upload" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" accept="image/*" onchange="previewImage(event)" />
        
        <div class="flex flex-col sm:flex-row justify-start gap-4 mt-4">
          <div id="current-image-container" class="hidden">
            <p class="mb-2 text-sm">р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ:</p>
            <div class="relative inline-block">
              <img id="current-image" class="w-40 h-40 object-cover rounded-lg border-2 border-gray-300" src="#" alt="Current Image" />
            </div>
          </div>
          <div id="image-preview-container" class="hidden">
            <p class="mb-2 text-sm">р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Гр╕лр╕бр╣И:</p>
            <img id="image-preview" class="w-40 h-40 object-cover rounded-lg border-2 border-blue-500" src="#" alt="Image Preview" />
          </div>
        </div>
      </div>

      <!-- Form Buttons -->
      <div class="flex flex-col sm:flex-row gap-2 sm:space-x-4">
        <button type="button" id="save-button" onclick="submitData()" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition duration-300 btn-3d">
          <i class="fas fa-save mr-2"></i> р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕е
        </button>
        <button type="button" id="update-button" onclick="updateData()" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition duration-300 hidden btn-3d">
          <i class="fas fa-edit mr-2"></i> р╣Бр╕Бр╣Йр╣Др╕Вр╕Вр╣Йр╕нр╕бр╕╣р╕е
        </button>
        <button type="button" id="cancel-button" onclick="cancelEdit()" class="w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition duration-300 hidden btn-3d">
          <i class="fas fa-times mr-2"></i> р╕вр╕Бр╣Ар╕ер╕┤р╕Б
        </button>
      </div>
    </form>

    <!-- Status Message -->
    <div id="status" class="mt-6 text-center"></div>
  </div>

  <!-- Database View -->
  <div id="database-container" class="bg-white rounded-lg shadow-lg p-4 sm:p-8 w-full max-w-full hidden animate-fade-in">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
      <h1 class="text-3xl sm:text-4xl font-bold text-blue-500 mb-4 sm:mb-0">ЁЯУКр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕╖р╕Ър╕кр╕зр╕Щ</h1>
      <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0 w-full sm:w-auto">
        <button onclick="refreshDatabase()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-300 mobile-btn flex items-center justify-center btn-3d">
          <i class="fas fa-sync-alt mr-2"></i> р╕гр╕╡р╣Ар╕Яр╕гр╕К
        </button>
        <button onclick="backToMainMenu()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-300 mobile-btn flex items-center justify-center btn-3d">
          <i class="fas fa-arrow-left mr-2"></i> р╕Бр╕ер╕▒р╕Ър╕лр╕Щр╣Йр╕▓р╕лр╕ер╕▒р╕Б
        </button>
      </div>
    </div>
    
    <!-- Search Box -->
    <div class="mb-6">
      <input type="text" id="search-input" placeholder="ЁЯФНр╕Др╣Йр╕Щр╕лр╕▓р╣Вр╕Фр╕вр╕Кр╕╖р╣Ир╕н,р╣Ар╕ер╕Вр╕Ър╕▒р╕Хр╕гр╕Ыр╕гр╕░р╕Кр╕▓р╕Кр╕Щ,р╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕г..." 
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" 
        oninput="searchRecords()">
    </div>
    
    <!-- Data Table -->
    <div class="overflow-x-auto table-responsive">
      <table id="data-table" class="min-w-full border-collapse border border-gray-300">
        <thead>
          <tr class="bg-blue-500 text-white">
            <th class="p-2 border">р╕ер╕│р╕Фр╕▒р╕Ъ</th>
            <th class="p-2 border">р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Бр╕ер╕░р╣Ар╕зр╕ер╕▓</th>
            <th class="p-2 border">р╣Ар╕ер╕Вр╕Ър╕▒р╕Хр╕гр╕Ыр╕гр╕░р╕Кр╕▓р╕Кр╕Щ</th>
            <th class="p-2 border">р╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е</th>
            <th class="p-2 border">р╕нр╕▓р╕вр╕╕</th>
            <th class="p-2 border">р╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕г</th>
            <th class="p-2 border">р╕кр╕Цр╕▓р╕Щр╕Чр╕╡р╣И</th>
            <th class="p-2 border">р╕гр╕╣р╕Ыр╕ар╕▓р╕Ю</th>
            <th class="p-2 border">р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕г</th>
          </tr>
        </thead>
        <tbody id="data-body">
          <!-- Data will be populated by JavaScript -->
          <tr>
            <td colspan="9" class="p-6 text-center">р╕Бр╕│р╕ер╕▒р╕Зр╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕е...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-[9999]">
    <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-lg p-5 bg-white rounded-lg shadow-2xl animate-popup">
      <button onclick="closeImageModal()" class="absolute top-2 right-2 text-gray-700 hover:text-red-500 text-2xl z-10">
        <i class="fas fa-times"></i>
      </button>
      <h2 id="modal-title" class="text-xl sm:text-2xl font-bold mb-3 text-center mobile-text-lg"></h2>
      <div class="flex justify-center items-center w-full min-h-[200px]" id="image-container">
        <div id="image-loading" class="text-center text-gray-500">
          <div class="loading-spinner mx-auto"></div>
          <p class="mt-4">р╕Бр╕│р╕ер╕▒р╕Зр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Ю...</p>
        </div>
        <img id="modal-image" class="max-w-full max-h-[60vh] object-contain hidden" src="" alt="р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Вр╕вр╕▓р╕в" 
             onload="document.getElementById('image-loading').classList.add('hidden'); this.classList.remove('hidden');"
             onerror="handleImageError(this)">
        <div id="image-error" class="text-center text-red-500 hidden">
          <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
          <p>р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Др╕Фр╣Й</p>
        </div>
      </div>
      <div class="mt-4 text-center">
        <button onclick="closeImageModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition duration-300 btn-3d">
          <i class="fas fa-times mr-2"></i> р╕Ыр╕┤р╕Ф
        </button>
        <a id="direct-image-link" href="#" target="_blank" class="ml-2 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition duration-300 btn-3d inline-block">
          <i class="fas fa-external-link-alt mr-2"></i> р╣Ар╕Ыр╕┤р╕Фр╕гр╕╣р╕Ыр╣Ар╕Хр╣Зр╕б
        </a>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-[9000]">
    <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 w-[95%] md:w-3/4 lg:w-2/3 max-h-[90vh] overflow-auto animate-popup">
      <button onclick="closeDetailModal()" class="absolute top-2 right-2 text-gray-700 hover:text-red-500 text-2xl">
        <i class="fas fa-times"></i>
      </button>
      <h2 id="detail-title" class="text-xl sm:text-2xl font-bold mb-4 text-center text-blue-500 mobile-text-lg"></h2>
      
      <div id="detail-content" class="space-y-4">
        <!-- Detail content will be populated by JavaScript -->
      </div>
      
      <div class="mt-6 text-center">
        <button onclick="exportToPDF()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition duration-300 mr-2 btn-3d pdf-btn-mobile">
          <i class="fas fa-file-pdf mr-2"></i> р╕кр╣Ир╕Зр╕нр╕нр╕Б PDF
        </button>
        <button onclick="closeDetailModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition duration-300 btn-3d">
          <i class="fas fa-times mr-2"></i> р╕Ыр╕┤р╕Ф
        </button>
      </div>
    </div>
  </div>

  <!-- JavaScript Code -->
  <script>
    // Main Variables
    const passwordInput = document.getElementById('password');
    const passwordStatus = document.getElementById('password-status');
    const loading = document.getElementById('loading');
    const passwordContainer = document.getElementById('password-container');
    const mainMenu = document.getElementById('main-menu');
    const formContainer = document.getElementById('form-container');
    const databaseContainer = document.getElementById('database-container');
    const idCardInput = document.getElementById('id-card');
    const idCardStatus = document.getElementById('id-card-status');
    const phoneInput = document.getElementById('phone');
    const phoneStatus = document.getElementById('phone-status');
    const birthdateInput = document.getElementById('birthdate');
    const ageDisplay = document.getElementById('age-display');
    const imageUpload = document.getElementById('image-upload');
    const saveButton = document.getElementById('save-button');
    const updateButton = document.getElementById('update-button');
    const cancelButton = document.getElementById('cancel-button');
    const recordIdInput = document.getElementById('record-id');
    const existingImageUrlInput = document.getElementById('existing-image-url');
    const currentImageContainer = document.getElementById('current-image-container');
    const currentImage = document.getElementById('current-image');
    
    let isEditMode = false;
    let currentRecord = null; // For PDF export
    
    // Thai Date Utilities
    const monthNamesEN = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const monthNamesTH = ['р╕бр╕Бр╕гр╕▓р╕Др╕б', 'р╕Бр╕╕р╕бр╕ар╕▓р╕Юр╕▒р╕Щр╕Шр╣М', 'р╕бр╕╡р╕Щр╕▓р╕Др╕б', 'р╣Ар╕бр╕йр╕▓р╕вр╕Щ', 'р╕Юр╕др╕йр╕ар╕▓р╕Др╕б', 'р╕бр╕┤р╕Цр╕╕р╕Щр╕▓р╕вр╕Щ', 'р╕Бр╕гр╕Бр╕Ор╕▓р╕Др╕б', 'р╕кр╕┤р╕Зр╕лр╕▓р╕Др╕б', 'р╕Бр╕▒р╕Щр╕вр╕▓р╕вр╕Щ', 'р╕Хр╕╕р╕ер╕▓р╕Др╕б', 'р╕Юр╕др╕ир╕Ир╕┤р╕Бр╕▓р╕вр╕Щ', 'р╕Шр╕▒р╕Щр╕зр╕▓р╕Др╕б'];
    const shortMonthNamesTH = ['р╕б.р╕Д.', 'р╕Б.р╕Ю.', 'р╕бр╕╡.р╕Д.', 'р╣Ар╕б.р╕в.', 'р╕Ю.р╕Д.', 'р╕бр╕┤.р╕в.', 'р╕Б.р╕Д.', 'р╕к.р╕Д.', 'р╕Б.р╕в.', 'р╕Х.р╕Д.', 'р╕Ю.р╕в.', 'р╕Ш.р╕Д.'];
    
    // Format Date and Time in Thai Format
    function formatThaiDateTime(dateTimeStr, includeTime = true) {
      if (!dateTimeStr) return "-";
      
      const date = new Date(dateTimeStr);
      if (isNaN(date.getTime())) return dateTimeStr;
      
      const day = date.getDate();
      const month = shortMonthNamesTH[date.getMonth()];
      const year = date.getFullYear() + 543;
      
      let thaiDate = `${day} ${month} ${year}`;
      
      if (includeTime) {
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        thaiDate += ` ${hours}:${minutes} р╕Щ.`;
      }
      
      return thaiDate;
    }
    
    // Format Thai Date from String
    function formatThaiDateString(dateStr) {
      if (!dateStr) return "-";
      
      console.log("Input date string:", dateStr);
      
      // Check for day/month/year format
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        try {
          const day = parseInt(parts[0]);
          const month = parseInt(parts[1]);
          const year = parseInt(parts[2]);
          
          console.log(`Parsed as day/month/year: ${day}/${month}/${year}`);
          
          // Convert to Thai format if valid
          if (!isNaN(day) && !isNaN(month) && !isNaN(year) && month >= 1 && month <= 12) {
            // Determine if Buddhist or Christian year
            let fullYear = year;
            if (year < 100) { // Short year format like 66 -> 2566
              fullYear = year + 2500;
            } else if (year >= 100 && year < 2000) { // likely already Buddhist year
              fullYear = year;
            } else if (year >= 2000 && year < 2500) { // Christian year -> Buddhist year
              fullYear = year + 543;
            } else if (year >= 2500) { // Already Buddhist year
              if (year - 543 >= 2000 && year - 543 < 2100) {
                fullYear = year - 543 + 543; // Keep original if valid
              } else {
                fullYear = year; // Already Buddhist year
              }
            }
            
            const result = `${day} ${monthNamesTH[month-1]} ${fullYear}`;
            console.log("Returning formatted date:", result);
            return result;
          }
        } catch (e) {
          console.error("Error parsing date string:", e);
        }
      }
      
      // Try other formats
      try {
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
          const day = date.getDate();
          const month = date.getMonth();
          const year = date.getFullYear();
          
          console.log(`Parsed date object: ${day}/${month+1}/${year}`);
          
          // Convert year to Buddhist era if needed
          let thaiYear = year;
          if (year >= 1900 && year < 2100) {
            thaiYear = year + 543; 
          }
          
          const result = `${day} ${monthNamesTH[month]} ${thaiYear}`;
          console.log("Returning formatted date from Date object:", result);
          return result;
        }
      } catch (e) {
        console.error("Error converting date format:", e);
      }
      
      // Return original if parsing fails
      return dateStr;
    }
    
    // Validate ID Card Number
    function validateIDCard() {
      const idCard = idCardInput.value;
      if (idCard.length !== 13 || isNaN(idCard)) {
        idCardStatus.textContent = 'тЭМр╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╣Ар╕ер╕Вр╕Ър╕▒р╕Хр╕гр╕Ыр╕гр╕░р╕Кр╕▓р╕Кр╕Щр╣Гр╕лр╣Йр╕Др╕гр╕Ъ13р╕лр╕ер╕▒р╕Б';
        idCardStatus.classList.remove('hidden');
        return false;
      } else {
        idCardStatus.textContent = '';
        idCardStatus.classList.add('hidden');
        return true;
      }
    }

    // Validate Phone Number
    function validatePhone() {
      const phoneNumbers = phoneInput.value.split('/').map(num => num.trim());
      let isValid = true;
      let errorMessages = [];

      phoneNumbers.forEach((phone, index) => {
        if (!/^0[0-9]{9}$/.test(phone)) {
          isValid = false;
          errorMessages.push(`тЭМр╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕гр╕Чр╕╡р╣И${index + 1}: "${phone}" р╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З(р╕Хр╣Йр╕нр╕Зр╕Вр╕╢р╣Йр╕Щр╕Хр╣Йр╕Щр╕Фр╣Йр╕зр╕в0р╣Бр╕ер╕░р╕Хр╕▓р╕бр╕Фр╣Йр╕зр╕в9р╕лр╕ер╕▒р╕Б)`);
        }
      });

      if (!isValid) {
        phoneStatus.innerHTML = errorMessages.join('<br>');
        return false;
      } else {
        phoneStatus.textContent = '';
        return true;
      }
    }

    // Check Password
    function checkPassword() {
      const password = passwordInput.value;
      showLoading();

      google.script.run
        .withSuccessHandler(function(response) {
          hideLoading();
          if (response.status === 'success') {
            passwordContainer.classList.add('hidden');
            mainMenu.classList.remove('hidden');
          } else {
            Swal.fire({
              title: "р╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щр╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З",
              text: "р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щр╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З",
              icon: "error",
              confirmButtonText: "р╕Хр╕Бр╕ер╕З",
            });
            passwordStatus.textContent = '';
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          Swal.fire({
            title: "р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф",
            text: "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щр╣Др╕Фр╣Й: " + error.message,
            icon: "error",
            confirmButtonText: "р╕Хр╕Бр╕ер╕З",
          });
        })
        .checkPassword(password);
    }
    
    // Logout Function
    function logout() {
      Swal.fire({
        title: "р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ?",
        text: "р╕Др╕╕р╕Ур╕Бр╕│р╕ер╕▒р╕Зр╕Ир╕░р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ Detective-X",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ",
        cancelButtonText: "р╕вр╕Бр╣Ар╕ер╕┤р╕Б"
      }).then((result) => {
        if (result.isConfirmed) {
          mainMenu.classList.add('hidden');
          passwordContainer.classList.remove('hidden');
          passwordInput.value = '';
        }
      });
    }
    
    // Return to Main Menu
    function backToMainMenu() {
      resetForm();
      formContainer.classList.add('hidden');
      databaseContainer.classList.add('hidden');
      mainMenu.classList.remove('hidden');
    }
    
    // Show Data Entry Form
    function showForm() {
      mainMenu.classList.add('hidden');
      formContainer.classList.remove('hidden');
      // Set default date/time
      const now = new Date();
      const localDatetime = new Date(now.getTime() - (now.getTimezoneOffset() * 60000))
        .toISOString()
        .slice(0, 16);
      document.getElementById('datetime').value = localDatetime;
    }
    
    // Show Database
    function showDatabase() {
      mainMenu.classList.add('hidden');
      databaseContainer.classList.remove('hidden');
      
      // Show loading message
      const tableBody = document.getElementById('data-body');
      tableBody.innerHTML = '<tr><td colspan="9" class="p-6 text-center">р╕Бр╕│р╕ер╕▒р╕Зр╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕е... <i class="fas fa-spinner fa-spin"></i></td></tr>';
      
      // Fetch data
      fetchRecords();
    }
    
    // Fetch All Records
    function fetchRecords() {
      showLoading();
      
      // Show loading message
      document.getElementById('data-body').innerHTML = `
        <tr>
          <td colspan="9" class="p-6 text-center">
            <div class="flex flex-col items-center justify-center">
              <div class="loading-spinner mb-4"></div>
              <p>р╕Бр╕│р╕ер╕▒р╕Зр╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ир╕▓р╕Бр╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣М...</p>
            </div>
          </td>
        </tr>
      `;
      
      try {
        google.script.run
          .withSuccessHandler(function(response) {
            hideLoading();
            
            console.log("Server response (fetchRecords):", response);
            
            // Check for valid response
            if (response === undefined || response === null) {
              console.error("р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕Ир╕▓р╕Бр╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣М");
              document.getElementById('data-body').innerHTML = `
                <tr>
                  <td colspan="9" class="p-6 text-center text-red-500">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ър╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Фр╣Й р╣Вр╕Ыр╕гр╕Фр╕ер╕нр╕Зр╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З
                  </td>
                </tr>
              `;
              return;
            }
            
            // Check for error response
            if (response && response.status === 'error') {
              console.error("Server error:", response.message);
              Swal.fire({
                title: "р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф",
                text: response.message || "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Фр╣Й",
                icon: "error",
                confirmButtonText: "р╕Хр╕Бр╕ер╕З",
              });
              return;
            }
            
            // Display data if valid array
            if (Array.isArray(response)) {
              console.log("р╕Ир╕│р╕Щр╕зр╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕гр╕▒р╕Ъ:", response.length);
              displayRecords(response);
            } else {
              console.error("р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕гр╕▒р╕Ър╣Др╕бр╣Ир╣Гр╕Кр╣Ир╕нр╕▓р╕гр╣Мр╣Ар╕гр╕вр╣М:", response);
              document.getElementById('data-body').innerHTML = `
                <tr>
                  <td colspan="9" class="p-6 text-center text-red-500">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕гр╕▒р╕Ър╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З р╣Вр╕Ыр╕гр╕Фр╕Хр╕┤р╕Фр╕Хр╣Ир╕нр╕Ьр╕╣р╣Йр╕Фр╕╣р╣Бр╕ер╕гр╕░р╕Ър╕Ъ
                  </td>
                </tr>
              `;
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            console.error("Error fetching records:", error);
            
            document.getElementById('data-body').innerHTML = `
              <tr>
                <td colspan="9" class="p-6 text-center text-red-500">
                  <i class="fas fa-exclamation-triangle mr-2"></i>
                  р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ър╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е 
                  <button onclick="refreshDatabase()" class="ml-2 bg-blue-500 text-white px-3 py-1 rounded btn-3d">
                    р╕ер╕нр╕Зр╣Гр╕лр╕бр╣И
                  </button>
                </td>
              </tr>
            `;
          })
          .getRecords();
      } catch (e) {
        hideLoading();
        console.error("Client-side error:", e);
        document.getElementById('data-body').innerHTML = `
          <tr>
            <td colspan="9" class="p-6 text-center text-red-500">
              <i class="fas fa-exclamation-triangle mr-2"></i>
              р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╕Чр╕╡р╣Ир╣Др╕бр╣Ир╕Др╕▓р╕Фр╕Др╕┤р╕Ф: ${e.message}
            </td>
          </tr>
        `;
      }
    }
    
    // Refresh Database
    function refreshDatabase() {
      document.getElementById('search-input').value = '';
      fetchRecords();
    }
    
    // Display Records in Table
    function displayRecords(records) {
      const tableBody = document.getElementById('data-body');
      tableBody.innerHTML = '';
      
      if (!records || records.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="9" class="p-6 text-center">р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е</td></tr>';
        return;
      }
      
      console.log("р╕Бр╕│р╕ер╕▒р╕Зр╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е " + records.length + " р╕гр╕▓р╕вр╕Бр╕▓р╕г");
      
      records.forEach((record, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        
        // Handle null or undefined values
        const safePrefix = record.prefix || '';
        const safeFullName = record.fullName || '';
        const safeIdCard = record.idCard || '';
        const safeAge = record.age || '';
        const safePhone = record.phone || '';
        const safeLocation = record.location || '';
        
        const hasImage = record.imageUrl && record.imageUrl.trim() !== '';
        
        // Escape strings for use in JavaScript
        const escapedName = (safePrefix + ' ' + safeFullName).replace(/'/g, "\\'");
        const escapedUrl = record.imageUrl ? record.imageUrl.replace(/'/g, "\\'") : '';
        
        row.innerHTML = `
          <td class="p-2 border text-center">${index + 1}</td>
          <td class="p-2 border thai-date">${formatThaiDateTime(record.datetime)}</td>
          <td class="p-2 border">${safeIdCard}</td>
          <td class="p-2 border">${safePrefix} ${safeFullName}</td>
          <td class="p-2 border text-center">${safeAge}</td>
          <td class="p-2 border">${safePhone}</td>
          <td class="p-2 border">${safeLocation}</td>
          <td class="p-2 border text-center">
            ${hasImage ? `
              <button onclick="showImage('${escapedUrl}', '${escapedName}')" 
                class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition duration-300 btn-3d">
                <i class="fas fa-image"></i> р╕Фр╕╣р╕гр╕╣р╕Ы
              </button>
            ` : 'р╣Др╕бр╣Ир╕бр╕╡р╕гр╕╣р╕Ы'}
          </td>
          <td class="p-2 border">
            <div class="flex flex-col space-y-1 md:flex-row md:space-y-0 md:space-x-1">
              <button onclick="viewDetails(${index})" 
                class="bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600 transition duration-300 btn-3d">
                <i class="fas fa-eye"></i> р╕Фр╕╣р╕Вр╣Йр╕нр╕бр╕╣р╕е
              </button>
              <button onclick="editRecord(${index})" 
                class="bg-yellow-500 text-white px-2 py-1 rounded text-sm hover:bg-yellow-600 transition duration-300 btn-3d">
                <i class="fas fa-edit"></i> р╣Бр╕Бр╣Йр╣Др╕В
              </button>
              <button onclick="confirmDeleteRecord(${index})" 
                class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600 transition duration-300 btn-3d">
                <i class="fas fa-trash"></i> р╕ер╕Ъ
              </button>
            </div>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Store records for search and edit functionality
      window.allRecords = records;
    }
    
    // Search Records
    function searchRecords() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      
      if (!window.allRecords) return;
      
      let filteredRecords;
      
      if (searchTerm.trim() === '') {
        filteredRecords = window.allRecords;
      } else {
        filteredRecords = window.allRecords.filter(record => {
          return (
            (record.idCard && record.idCard.toLowerCase().includes(searchTerm)) ||
            (record.fullName && record.fullName.toLowerCase().includes(searchTerm)) ||
            (record.phone && record.phone.toLowerCase().includes(searchTerm)) ||
            (record.location && record.location.toLowerCase().includes(searchTerm))
          );
        });
      }
      
      displayRecords(filteredRecords);
    }
    
    // Show Image Modal
    function showImage(imageUrl, personName) {
      // Prevent event propagation if clicked from within details modal
      if (event && event.stopPropagation) {
        event.stopPropagation();
      }
      
      const modalImage = document.getElementById('modal-image');
      const modalTitle = document.getElementById('modal-title');
      const directImageLink = document.getElementById('direct-image-link');
      const imageLoading = document.getElementById('image-loading');
      const imageError = document.getElementById('image-error');
      
      // Reset status
      modalImage.classList.add('hidden');
      imageLoading.classList.remove('hidden');
      imageError.classList.add('hidden');
      
      // Set data
      modalTitle.textContent = `р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Вр╕нр╕З ${personName}`;
      modalImage.src = imageUrl;
      directImageLink.href = imageUrl;
      
      // Show modal
      document.getElementById('image-modal').classList.remove('hidden');
      
      // Log for debugging
      console.log("р╣Бр╕кр╕Фр╕Зр╕гр╕╣р╕Ыр╕ар╕▓р╕Ю:", imageUrl);
    }
    
    // Handle Image Load Error
    function handleImageError(imgElement) {
      console.error("р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╣Др╕Фр╣Й:", imgElement.src);
      document.getElementById('image-loading').classList.add('hidden');
      document.getElementById('image-error').classList.remove('hidden');
      imgElement.classList.add('hidden');
    }
    
    // Close Image Modal
    function closeImageModal() {
      document.getElementById('image-modal').classList.add('hidden');
      
      // Reset image data
      setTimeout(() => {
        document.getElementById('modal-image').src = '';
      }, 300);
    }
    
    // View Record Details
    function viewDetails(index) {
      const record = window.allRecords[index];
      currentRecord = record; // Store for PDF export
      const detailTitle = document.getElementById('detail-title');
      const detailContent = document.getElementById('detail-content');
      
      detailTitle.textContent = `р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Вр╕нр╕З ${record.prefix || ''} ${record.fullName || ''}`;
      
      const hasImage = record.imageUrl && record.imageUrl.trim() !== '';
      
      // Escape strings for use in JavaScript
      const escapedImageUrl = hasImage ? record.imageUrl.replace(/'/g, "\\'") : '';
      const escapedName = `${(record.prefix || '')} ${(record.fullName || '')}`.replace(/'/g, "\\'");
      
      // Convert birthdate to Thai format
      let birthDateThai = "-";
      if (record.birthdate) {
        try {
          console.log("Original birthdate in viewDetails:", record.birthdate);
          birthDateThai = formatThaiDateString(record.birthdate);
          console.log("Formatted birthdate in viewDetails:", birthDateThai);
        } catch (error) {
          console.error("Error formatting birthdate:", error);
          birthDateThai = record.birthdate;
        }
      }
      
      detailContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="pdf-content">
          <div class="space-y-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-blue-600 mb-3 border-b border-gray-300 pb-2">р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕▒р╣Ир╕зр╣Др╕Ы</h3>
              <div class="grid grid-cols-1 gap-3">
                <div>
                  <p class="text-gray-600 text-sm">р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Бр╕ер╕░р╣Ар╕зр╕ер╕▓:</p>
                  <p class="font-medium thai-date">${formatThaiDateTime(record.datetime)}</p>
                </div>
                <div>
                  <p class="text-gray-600 text-sm">р╣Ар╕ер╕Вр╕Ър╕▒р╕Хр╕гр╕Ыр╕гр╕░р╕Кр╕▓р╕Кр╕Щ:</p>
                  <p class="font-medium">${record.idCard || '-'}</p>
                </div>
                <div>
                  <p class="text-gray-600 text-sm">р╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е:</p>
                  <p class="font-medium">${record.prefix || ''} ${record.fullName || '-'}</p>
                </div>
                <div>
                  <p class="text-gray-600 text-sm">р╕зр╕▒р╕Щр╣Ар╕Бр╕┤р╕Ф:</p>
                  <p class="font-medium thai-date">${birthDateThai}</p>
                </div>
                <div>
                  <p class="text-gray-600 text-sm">р╕нр╕▓р╕вр╕╕:</p>
                  <p class="font-medium">${record.age || '-'} р╕Ыр╕╡</p>
                </div>
              </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-blue-600 mb-3 border-b border-gray-300 pb-2">р╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣И</h3>
              <div class="grid grid-cols-1 gap-3">
                <div>
                  <p class="text-gray-600 text-sm">р╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣Ир╕Хр╕▓р╕бр╕Ър╕▒р╕Хр╕гр╕Ыр╕гр╕░р╕Кр╕▓р╕Кр╕Щ:</p>
                  <p class="font-medium">${record.addressId || '-'}</p>
                </div>
                <div>
                  <p class="text-gray-600 text-sm">р╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣Ир╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ:</p>
                  <p class="font-medium">${record.addressCurrent || '-'}</p>
                </div>
              </div>
            </div>
          </div>
          
          <div class="space-y-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-blue-600 mb-3 border-b border-gray-300 pb-2">р╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╣Ир╕нр╣Бр╕ер╕░р╕кр╕Цр╕▓р╕Щр╕Чр╕╡р╣И</h3>
              <div class="grid grid-cols-1 gap-3">
                <div>
                  <p class="text-gray-600 text-sm">р╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕г:</p>
                  <p class="font-medium">${record.phone || '-'}</p>
                </div>
                <div>
                  <p class="text-gray-600 text-sm">р╕кр╕Цр╕▓р╕Щр╕Чр╕╡р╣И:</p>
                  <p class="font-medium">${record.location || '-'}</p>
                </div>
                <div>
                  <p class="text-gray-600 text-sm">р╕Юр╕┤р╕Бр╕▒р╕Ф:</p>
                  <p class="font-medium">${record.latlong || '-'}</p>
                </div>
              </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold text-blue-600 mb-3 border-b border-gray-300 pb-2">р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф</h3>
              <p class="whitespace-pre-line">${record.details || '-'}</p>
            </div>
            
            ${hasImage ? `
              <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-blue-600 mb-3 border-b border-gray-300 pb-2">р╕гр╕╣р╕Ыр╕ар╕▓р╕Ю</h3>
                <div class="flex justify-center">
                  <div class="relative">
                    <img src="${record.imageUrl}" alt="р╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Вр╕нр╕З ${record.fullName}" 
                      class="w-48 h-48 object-cover rounded-lg border-2 border-gray-300 pdf-image">
                    <button onclick="event.stopPropagation(); showImage('${escapedImageUrl}', '${escapedName}')" 
                      class="absolute bottom-2 right-2 bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition duration-300 pdf-hide">
                      <i class="fas fa-search-plus"></i>
                    </button>
                  </div>
                </div>
              </div>
            ` : '<div class="bg-gray-50 p-4 rounded-lg"><h3 class="text-lg font-semibold text-blue-600 mb-3 border-b border-gray-300 pb-2">р╕гр╕╣р╕Ыр╕ар╕▓р╕Ю</h3><p class="text-center text-gray-500">р╣Др╕бр╣Ир╕бр╕╡р╕гр╕╣р╕Ыр╕ар╕▓р╕Ю</p></div>'}
          </div>
        </div>
      `;
      
      document.getElementById('detail-modal').classList.remove('hidden');
    }
    
    // Close Detail Modal
    function closeDetailModal() {
      document.getElementById('detail-modal').classList.add('hidden');
      currentRecord = null;
    }
    
    // Export to PDF
    function exportToPDF() {
      if (!currentRecord) {
        Swal.fire({
          title: "р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф",
          text: "р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╕лр╕гр╕▒р╕Ър╕кр╣Ир╕Зр╕нр╕нр╕Б",
          icon: "error",
          confirmButtonText: "р╕Хр╕Бр╕ер╕З",
        });
        return;
      }
      
      showLoading();
      
      // Hide expand buttons before capturing
      const pdfHideElements = document.querySelectorAll('.pdf-hide');
      pdfHideElements.forEach(el => el.style.display = 'none');
      
      // Enlarge images for PDF
      const pdfImages = document.querySelectorAll('.pdf-image');
      pdfImages.forEach(img => {
        img.style.width = '240px';
        img.style.height = '240px';
      });
      
      try {
        // Convert content to image before creating PDF to handle Thai fonts
        const pdfContent = document.getElementById('pdf-content');
        
        // Use html2canvas to convert HTML to image
        html2canvas(pdfContent, {
          scale: 2, // Increase resolution
          useCORS: true, // Allow using images from external URLs
          logging: false,
          letterRendering: true,
          allowTaint: true
        }).then(canvas => {
          try {
            // Convert canvas to image
            const imgData = canvas.toDataURL('image/png');
            
            // Setup jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Create document header with Thai text
            const headerCanvas = document.createElement('canvas');
            headerCanvas.width = 2100; // 10x wider for clarity
            headerCanvas.height = 500;
            const headerCtx = headerCanvas.getContext('2d');
            
            // Draw blue background
            headerCtx.fillStyle = '#3B82F6'; // bg-blue-500
            headerCtx.fillRect(0, 0, 2100, 500);
            
            // Add white text - document title
            headerCtx.fillStyle = '#FFFFFF';
            headerCtx.font = 'bold 120px Kanit, sans-serif';
            headerCtx.textAlign = 'center';
            headerCtx.fillText('р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕кр╕╖р╕Ър╕кр╕зр╕Щ', 1050, 150);
            
            // Person name
            headerCtx.font = 'bold 80px Kanit, sans-serif';
            headerCtx.fillText(`${currentRecord.prefix || ''} ${currentRecord.fullName || ''}`, 1050, 250);
            
            // ID card number
            headerCtx.font = '70px Kanit, sans-serif';
            headerCtx.fillText(`${currentRecord.idCard || 'р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕'}`, 1050, 350);
            
            // Print date
            headerCtx.font = '60px Kanit, sans-serif';
            headerCtx.fillText(`р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕Юр╕┤р╕бр╕Юр╣М: ${formatThaiDateTime(new Date())}`, 1050, 450);
            
            // Convert canvas to image
            const headerImgData = headerCanvas.toDataURL('image/png');
            
            // Calculate dimensions for A4
            const imgWidth = 210; // A4 width in mm (297 is height)
            const pageHeight = 297;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            
            // First page - add header and content
            doc.addImage(headerImgData, 'PNG', 0, 0, 210, 50);
            
            // Draw divider line
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.5);
            doc.line(10, 52, 200, 52);
            
            // Start content
            let position = 55;
            
            // Add content from canvas image
            doc.addImage(imgData, 'PNG', 10, position, imgWidth - 20, imgHeight);
            
            // Handle multiple pages
            heightLeft -= (pageHeight - position);
            
            while (heightLeft > 0) {
              position = 0; // Start at top of new page
              doc.addPage();
              
              // Create header for continuation pages
              const nextHeaderCanvas = document.createElement('canvas');
              nextHeaderCanvas.width = 2100;
              nextHeaderCanvas.height = 200;
              const nextHeaderCtx = nextHeaderCanvas.getContext('2d');
              
              // Draw blue background
              nextHeaderCtx.fillStyle = '#3B82F6';
              nextHeaderCtx.fillRect(0, 0, 2100, 200);
              
              // Add white text
              nextHeaderCtx.fillStyle = '#FFFFFF';
              nextHeaderCtx.font = 'bold 80px Kanit, sans-serif';
              nextHeaderCtx.textAlign = 'center';
              nextHeaderCtx.fillText('р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕кр╕╖р╕Ър╕кр╕зр╕Щ (р╕Хр╣Ир╕н)', 1050, 120);
              
              // Convert canvas to image
              const nextHeaderImgData = nextHeaderCanvas.toDataURL('image/png');
              
              // Add header to PDF
              doc.addImage(nextHeaderImgData, 'PNG', 0, 0, 210, 20);
              doc.setDrawColor(220, 220, 220);
              doc.setLineWidth(0.5);
              doc.line(10, 22, 200, 22);
              
              // Adjust position for content
              position = 25;
              
              doc.addImage(imgData, 'PNG', 10, position - (pageHeight - 55), imgWidth - 20, imgHeight);
              heightLeft -= (pageHeight - 25);
            }
            
            // Add page numbers (using canvas for Thai text)
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              
              const pageCanvas = document.createElement('canvas');
              pageCanvas.width = 1000;
              pageCanvas.height = 100;
              const pageCtx = pageCanvas.getContext('2d');
              pageCtx.font = '40px Kanit, sans-serif';
              pageCtx.fillStyle = '#646464';
              pageCtx.textAlign = 'center';
              pageCtx.fillText(`р╕лр╕Щр╣Йр╕▓ ${i} р╕Ир╕▓р╕Б ${pageCount}`, 500, 50);
              const pageImgData = pageCanvas.toDataURL('image/png');
              doc.addImage(pageImgData, 'PNG', 55, 290, 100, 10);
            }
            
            // Create timestamp for filename
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const fileName = `Detective-X_${currentRecord.fullName || 'Record'}_${timestamp}.pdf`;
            
            // Download PDF directly
            doc.save(fileName);
            
            // Restore display of expand buttons and image sizes
            pdfHideElements.forEach(el => el.style.display = 'block');
            pdfImages.forEach(img => {
              img.style.width = '';
              img.style.height = '';
            });
            
            hideLoading();
            
            Swal.fire({
              title: "р╕кр╣Ир╕Зр╕нр╕нр╕Бр╕кр╕│р╣Ар╕гр╣Зр╕И",
              text: "р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Ыр╣Зр╕Щр╣Др╕Яр╕ер╣М PDF р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з",
              icon: "success",
              confirmButtonText: "р╕Хр╕Бр╕ер╕З",
            });
            
          } catch (error) {
            // Restore display elements
            pdfHideElements.forEach(el => el.style.display = 'block');
            pdfImages.forEach(img => {
              img.style.width = '';
              img.style.height = '';
            });
            
            hideLoading();
            console.error("Error generating PDF:", error);
            
            Swal.fire({
              title: "р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф",
              text: "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М PDF р╣Др╕Фр╣Й: " + error.message,
              icon: "error",
              confirmButtonText: "р╕Хр╕Бр╕ер╕З",
            });
          }
        }).catch(error => {
          // Restore display elements
          pdfHideElements.forEach(el => el.style.display = 'block');
          pdfImages.forEach(img => {
            img.style.width = '';
            img.style.height = '';
          });
          
          hideLoading();
          console.error("Error generating canvas:", error);
          
          Swal.fire({
            title: "р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф",
            text: "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М PDF р╣Др╕Фр╣Й: " + error.message,
            icon: "error",
            confirmButtonText: "р╕Хр╕Бр╕ер╕З",
          });
        });
      } catch (e) {
        // Restore display elements
        pdfHideElements.forEach(el => el.style.display = 'block');
        pdfImages.forEach(img => {
          img.style.width = '';
          img.style.height = '';
        });
        
        hideLoading();
        console.error("Error:", e);
        
        Swal.fire({
          title: "р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф",
          text: "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М PDF р╣Др╕Фр╣Й: " + e.message,
          icon: "error",
          confirmButtonText: "р╕Хр╕Бр╕ер╕З",
        });
      }
    }
    
    // Edit Record
    function editRecord(index) {
      const record = window.allRecords[index];
      isEditMode = true;
      
      // Switch to form view
      databaseContainer.classList.add('hidden');
      formContainer.classList.remove('hidden');
      
      // Store record ID
      recordIdInput.value = record.id;
      
      // Populate form fields
      document.getElementById('datetime').value = record.datetime;
      idCardInput.value = record.idCard;
      document.getElementById('prefix').value = record.prefix;
      document.getElementById('fullname').value = record.fullName;
      
      // Convert birth date to format required by input type="date"
      if (record.birthdate) {
        try {
          const parts = record.birthdate.split('/');
          if (parts.length === 3) {
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const yearBE = parseInt(parts[2]);
            const yearAD = yearBE - 543;
            
            const dateString = `${yearAD}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            birthdateInput.value = dateString;
          }
        } catch (error) {
          console.error("Error parsing birthdate:", error);
        }
      }
      calculateAge();
      
      document.getElementById('address-id').value = record.addressId;
      document.getElementById('address-current').value = record.addressCurrent;
      phoneInput.value = record.phone;
      document.getElementById('location').value = record.location;
      document.getElementById('latlong').value = record.latlong;
      document.getElementById('details').value = record.details;
      
      // Show existing image if available
      if (record.imageUrl && record.imageUrl.trim() !== '') {
        existingImageUrlInput.value = record.imageUrl;
        currentImage.src = record.imageUrl;
        currentImageContainer.classList.remove('hidden');
      } else {
        existingImageUrlInput.value = '';
        currentImageContainer.classList.add('hidden');
      }
      
      // Show update and cancel buttons, hide save button
      saveButton.classList.add('hidden');
      updateButton.classList.remove('hidden');
      cancelButton.classList.remove('hidden');
    }
    
    // Cancel Edit
    function cancelEdit() {
      resetForm();
      
      databaseContainer.classList.remove('hidden');
      formContainer.classList.add('hidden');
    }
    
    // Reset Form
    function resetForm() {
      isEditMode = false;
      recordIdInput.value = '';
      existingImageUrlInput.value = '';
      document.getElementById('field-form').reset();
      
      // Hide current image and preview
      currentImageContainer.classList.add('hidden');
      document.getElementById('image-preview-container').classList.add('hidden');
      
      // Show save button, hide update and cancel buttons
      saveButton.classList.remove('hidden');
      updateButton.classList.add('hidden');
      cancelButton.classList.add('hidden');
      
      // Reset status messages
      idCardStatus.textContent = '';
      idCardStatus.classList.add('hidden');
      phoneStatus.textContent = '';
      ageDisplay.textContent = '';
    }
    
    // Get Current Location
    function getLatLong() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          document.getElementById('latlong').value = `${position.coords.latitude}, ${position.coords.longitude}`;
        }, error => {
          Swal.fire({
            title: "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Юр╕┤р╕Бр╕▒р╕Фр╣Др╕Фр╣Й",
            text: error.message,
            icon: "error",
            confirmButtonText: "р╕Хр╕Бр╕ер╕З",
          });
        });
      } else {
        Swal.fire({
          title: "р╣Ар╕Ър╕гр╕▓р╕зр╣Мр╣Ар╕Лр╕нр╕гр╣Мр╣Др╕бр╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ъ",
          text: "р╣Ар╕Ър╕гр╕▓р╕зр╣Мр╣Ар╕Лр╕нр╕гр╣Мр╕Вр╕нр╕Зр╕Др╕╕р╕Ур╣Др╕бр╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕Юр╕┤р╕Бр╕▒р╕Ф",
          icon: "error",
          confirmButtonText: "р╕Хр╕Бр╕ер╕З",
        });
      }
    }

    // Calculate Age
    function calculateAge() {
      const birthdate = new Date(birthdateInput.value);
      const today = new Date();
      let age = today.getFullYear() - birthdate.getFullYear();
      const monthDifference = today.getMonth() - birthdate.getMonth();
      if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birthdate.getDate())) {
        age--;
      }
      ageDisplay.textContent = `р╕нр╕▓р╕вр╕╕: ${age} р╕Ыр╕╡`;
      return age;
    }

    // Preview Uploaded Image
    function previewImage(event) {
      const input = event.target;
      const previewContainer = document.getElementById('image-preview-container');
      const previewImage = document.getElementById('image-preview');

      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewImage.src = e.target.result;
          previewContainer.classList.remove('hidden');
        };
        reader.readAsDataURL(input.files[0]);
      } else {
        previewImage.src = '#';
        previewContainer.classList.add('hidden');
      }
    }

    // Validate Form
    function validateForm() {
      const errors = [];

      if (!validateIDCard()) {
        errors.push('тЭМр╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╣Ар╕ер╕Вр╕Ър╕▒р╕Хр╕гр╕Ыр╕гр╕░р╕Кр╕▓р╕Кр╕Щр╣Гр╕лр╣Йр╕Др╕гр╕Ъ13р╕лр╕ер╕▒р╕Б');
      }

      if (!validatePhone()) {
        errors.push('тЭМр╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕гр╣Гр╕лр╣Йр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З(р╕Хр╣Йр╕нр╕Зр╕Вр╕╢р╣Йр╕Щр╕Хр╣Йр╕Щр╕Фр╣Йр╕зр╕в 0 р╣Бр╕ер╕░р╕Хр╕▓р╕бр╕Фр╣Йр╕зр╕в 9 р╕лр╕ер╕▒р╕Б)');
      }

      const requiredFields = [
        { id: 'datetime', message: 'тЭМр╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Бр╕ер╕░р╣Ар╕зр╕ер╕▓' },
        { id: 'prefix', message: 'тЭМр╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕Др╕│р╕Щр╕│р╕лр╕Щр╣Йр╕▓' },
        { id: 'fullname', message: 'тЭМр╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е' },
        { id: 'birthdate', message: 'тЭМр╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕зр╕▒р╕Щ/р╣Ар╕Фр╕╖р╕нр╕Щ/р╕Ыр╕╡р╣Ар╕Бр╕┤р╕Ф' },
        { id: 'address-id', message: 'тЭМр╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣Ир╕Хр╕▓р╕бр╕Ър╕▒р╕Хр╕гр╕Ыр╕гр╕░р╕Кр╕▓р╕Кр╕Щ' },
        { id: 'address-current', message: 'тЭМр╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣Ир╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ' },
        { id: 'location', message: 'тЭМр╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕кр╕Цр╕▓р╕Щр╕Чр╕╡р╣И' },
        { id: 'latlong', message: 'тЭМр╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Юр╕┤р╕Бр╕▒р╕Ф' },
        { id: 'details', message: 'тЭМр╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф' }
      ];

      requiredFields.forEach(field => {
        const input = document.getElementById(field.id);
        if (!input.value.trim()) {
          errors.push(field.message);
        }
      });

      return errors;
    }

    // Display Validation Errors
    function showValidationErrors(errors) {
      const errorList = errors.map(error => `<li>${error}</li>`).join('');
      Swal.fire({
        title: "р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ",
        html: `р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Хр╣Ир╕нр╣Др╕Ыр╕Щр╕╡р╣Й:<ul class="text-left mt-4">${errorList}</ul>`,
        icon: "error",
        confirmButtonText: "р╕Хр╕Бр╕ер╕З",
      });
    }

    // Show Loading Indicator
    function showLoading() {
      loading.classList.remove('hidden');
    }

    // Hide Loading Indicator
    function hideLoading() {
      loading.classList.add('hidden');
    }

    // Submit New Record
    function submitData() {
      const errors = validateForm();

      if (errors.length > 0) {
        showValidationErrors(errors);
        return;
      }

      showLoading();

      const age = calculateAge();
      const birthdate = new Date(birthdateInput.value);
      const birthYear = birthdate.getFullYear() + 543;
      const birthMonth = birthdate.getMonth() + 1;
      const birthDay = birthdate.getDate();
      const birthdateBE = `${birthDay}/${birthMonth}/${birthYear}`;

      const formData = {
        datetime: document.getElementById('datetime').value,
        idCard: idCardInput.value,
        prefix: document.getElementById('prefix').value,
        fullName: document.getElementById('fullname').value,
        birthdate: birthdateBE,
        age: age,
        addressId: document.getElementById('address-id').value,
        addressCurrent: document.getElementById('address-current').value,
        phone: phoneInput.value,
        location: document.getElementById('location').value,
        latlong: document.getElementById('latlong').value,
        details: document.getElementById('details').value,
        image: imageUpload.files[0] ? imageUpload.files[0] : null
      };

      if (formData.image) {
        const reader = new FileReader();
        reader.onloadend = function() {
          const base64Image = reader.result.split(',')[1];
          formData.image = {
            base64: base64Image,
            type: formData.image.type,
            name: formData.image.name
          };
          sendData(formData);
        };
        reader.readAsDataURL(formData.image);
      } else {
        sendData(formData);
      }
    }
    
    // Update Existing Record
    function updateData() {
      const errors = validateForm();

      if (errors.length > 0) {
        showValidationErrors(errors);
        return;
      }

      showLoading();

      const age = calculateAge();
      const birthdate = new Date(birthdateInput.value);
      const birthYear = birthdate.getFullYear() + 543;
      const birthMonth = birthdate.getMonth() + 1;
      const birthDay = birthdate.getDate();
      const birthdateBE = `${birthDay}/${birthMonth}/${birthYear}`;

      const formData = {
        id: recordIdInput.value,
        datetime: document.getElementById('datetime').value,
        idCard: idCardInput.value,
        prefix: document.getElementById('prefix').value,
        fullName: document.getElementById('fullname').value,
        birthdate: birthdateBE,
        age: age,
        addressId: document.getElementById('address-id').value,
        addressCurrent: document.getElementById('address-current').value,
        phone: phoneInput.value,
        location: document.getElementById('location').value,
        latlong: document.getElementById('latlong').value,
        details: document.getElementById('details').value,
        existingImageUrl: existingImageUrlInput.value,
        image: imageUpload.files[0] ? imageUpload.files[0] : null
      };

      if (formData.image) {
        const reader = new FileReader();
        reader.onloadend = function() {
          const base64Image = reader.result.split(',')[1];
          formData.image = {
            base64: base64Image,
            type: formData.image.type,
            name: formData.image.name
          };
          updateRecord(formData);
        };
        reader.readAsDataURL(formData.image);
      } else {
        updateRecord(formData);
      }
    }

    // Send New Record Data
    function sendData(formData) {
      google.script.run
        .withSuccessHandler(function(response) {
          hideLoading();

          if (response.status === 'success') {
            Swal.fire({
              title: "р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╣Ар╕гр╣Зр╕И!",
              icon: "success",
              confirmButtonText: "р╕Хр╕Бр╕ер╕З",
            }).then(() => {
              resetForm();
              backToMainMenu();
            });
          } else {
            Swal.fire({
              title: "р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И",
              text: response.message,
              icon: "error",
              confirmButtonText: "р╕Хр╕Бр╕ер╕З",
            });
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          Swal.fire({
            title: "р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф",
            text: "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Фр╣Й: " + error.message,
            icon: "error",
            confirmButtonText: "р╕Хр╕Бр╕ер╕З",
          });
        })
        .submitFormData(formData);
    }
    
    // Send Update Record Data
    function updateRecord(formData) {
      google.script.run
        .withSuccessHandler(function(response) {
          hideLoading();

          if (response.status === 'success') {
            Swal.fire({
              title: "р╣Бр╕Бр╣Йр╣Др╕Вр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╣Ар╕гр╣Зр╕И!",
              icon: "success",
              confirmButtonText: "р╕Хр╕Бр╕ер╕З",
            }).then(() => {
              resetForm();
              databaseContainer.classList.remove('hidden');
              formContainer.classList.add('hidden');
              fetchRecords();
            });
          } else {
            Swal.fire({
              title: "р╣Бр╕Бр╣Йр╣Др╕Вр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И",
              text: response.message,
              icon: "error",
              confirmButtonText: "р╕Хр╕Бр╕ер╕З",
            });
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          Swal.fire({
            title: "р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф",
            text: "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Бр╕Бр╣Йр╣Др╕Вр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Фр╣Й: " + error.message,
            icon: "error",
            confirmButtonText: "р╕Хр╕Бр╕ер╕З",
          });
        })
        .updateFormData(formData);
    }
    
    // Enter key in password field
    passwordInput.addEventListener('keyup', function(event) {
      if (event.key === 'Enter') {
        checkPassword();
      }
    });
    
    // Confirm Delete Record
    function confirmDeleteRecord(index) {
      const record = window.allRecords[index];
      
      Swal.fire({
        title: "р╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Бр╕▓р╕гр╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е",
        html: `р╕Др╕╕р╕Ур╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Вр╕нр╕З <strong>${record.prefix} ${record.fullName}</strong> р╣Гр╕Кр╣Ир╕лр╕гр╕╖р╕нр╣Др╕бр╣И?<br>р╕Бр╕▓р╕гр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╕Щр╕╡р╣Йр╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕гр╕╡р╕вр╕Бр╕Др╕╖р╕Щр╣Др╕Фр╣Й`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "р╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е",
        cancelButtonText: "р╕вр╕Бр╣Ар╕ер╕┤р╕Б",
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
      }).then((result) => {
        if (result.isConfirmed) {
          deleteRecord(record.id);
        }
      });
    }
    
    // Delete Record
    function deleteRecord(recordId) {
      showLoading();
      
      google.script.run
        .withSuccessHandler(function(response) {
          hideLoading();
          
          if (response.status === 'success') {
            Swal.fire({
              title: "р╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╣Ар╕гр╣Зр╕И",
              text: "р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Цр╕╣р╕Бр╕ер╕Ър╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ър╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з",
              icon: "success",
              confirmButtonText: "р╕Хр╕Бр╕ер╕З",
            }).then(() => {
              fetchRecords(); // Reload data
            });
          } else {
            Swal.fire({
              title: "р╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И",
              text: response.message || "р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е",
              icon: "error",
              confirmButtonText: "р╕Хр╕Бр╕ер╕З",
            });
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          
          Swal.fire({
            title: "р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф",
            text: "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕ер╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Фр╣Й: " + error.message,
            icon: "error",
            confirmButtonText: "р╕Хр╕Бр╕ер╕З",
          });
        })
        .deleteRecord(recordId);
    }
    
    // Close modals when clicking on background
    window.onclick = function(event) {
      if (event.target === document.getElementById('image-modal')) {
        closeImageModal();
      }
      if (event.target === document.getElementById('detail-modal')) {
        closeDetailModal();
      }
    };
  </script>
</body>
</html>